<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Observability Factory - Demo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            min-height: 100vh;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #0078d4;
        }

        .header h1 {
            color: #0078d4;
            font-size: 2.2em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            border-bottom: 2px solid #e1e1e1;
            margin-bottom: 30px;
            background-color: #fafafa;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button:hover {
            background-color: #f0f8ff;
            color: #0078d4;
        }

        .tab-button.active {
            background-color: white;
            color: #0078d4;
            border-bottom-color: #0078d4;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Cards and Sections */
        .card {
            background: white;
            border: 1px solid #e1e1e1;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: box-shadow 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: #0078d4;
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: 600;
        }

        /* Placeholder Content */
        .placeholder {
            text-align: center;
            padding: 40px;
            color: #666;
            background-color: #f9f9f9;
            border: 2px dashed #ccc;
            border-radius: 6px;
        }

        .placeholder h3 {
            color: #666;
            margin-bottom: 10px;
        }

        .placeholder p {
            font-style: italic;
        }

        /* Buttons */
        .btn {
            background-color: #0078d4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background-color: #106ebe;
        }

        .btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn.processing {
            position: relative;
            color: transparent;
        }

        .btn.processing::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid #fff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .btn-secondary {
            background-color: #6c757d;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-danger {
            background-color: #dc3545;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.9em;
            margin: 0;
        }

        /* Status Indicators */
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .status-ready {
            background-color: #d4edda;
            color: #155724;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        /* Section Headers */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e1e1e1;
        }

        .section-header h2 {
            color: #0078d4;
            font-size: 1.5em;
            font-weight: 600;
        }

        /* Demo Stats */
        .demo-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            text-align: center;
            padding: 25px 20px;
            background: linear-gradient(135deg, #0078d4 0%, #40e0d0 100%);
            color: white;
            border-radius: 12px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: default;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,120,212,0.3);
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* Toast Notifications */
        .toast-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1500;
            animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 400px;
        }

        .toast-message.success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .toast-message.error {
            background: linear-gradient(135deg, #dc3545, #e83e8c);
        }

        .toast-message.info {
            background: linear-gradient(135deg, #17a2b8, #6f42c1);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(100%); }
        }

        /* Loading States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(2px);
        }

        .loading-spinner {
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e3e3e3;
            border-top: 4px solid #0078d4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .loading-text {
            color: #0078d4;
            font-weight: 500;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .demo-stats {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
        }

        /* Tree Display Styles */
        .tree-display {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 25px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.8;
            overflow-x: auto;
            margin-bottom: 20px;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .tree-display:empty::before {
            content: "üå≥ No business processes defined yet. Create your first step to see the hierarchy tree.";
            color: #6c757d;
            font-style: italic;
            font-family: 'Segoe UI', sans-serif;
            font-size: 16px;
            display: block;
            text-align: center;
            padding: 40px 20px;
        }

        .tree-display strong {
            color: #0078d4;
            font-weight: bold;
        }

        .step-name {
            color: #28a745;
            font-weight: 600;
        }

        .tree-legend {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .tree-legend h4 {
            margin-bottom: 10px;
            color: #856404;
            font-size: 1em;
        }

        .legend-items {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .legend-items span {
            background-color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
            border: 1px solid #ffeaa7;
        }

        .tree-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tree-actions button {
            font-size: 0.9em;
        }

        /* Step List Table Styles */
        .step-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .step-table th,
        .step-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e1e1;
        }

        .step-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
        }

        .step-table tr:hover {
            background-color: #f8f9fa;
        }

        .step-row {
            transition: background-color 0.2s ease;
        }

        .step-actions {
            display: flex;
            gap: 8px;
        }

        .step-process {
            color: #0078d4;
            font-weight: 500;
        }

        .step-name-cell {
            color: #28a745;
            font-weight: 500;
        }

        .step-signals {
            font-size: 0.9em;
            color: #6c757d;
        }

        .step-updated {
            font-size: 0.9em;
            color: #6c757d;
        }

        /* No Data Message */
        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-style: italic;
        }

        /* Confirmation Dialog Styles */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .confirm-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            text-align: center;
        }

        .confirm-content h3 {
            margin-bottom: 15px;
            color: #dc3545;
        }

        .confirm-content p {
            margin-bottom: 20px;
            color: #6c757d;
        }

        .confirm-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #495057;
        }

        .form-group input,
        .form-group textarea {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #0078d4;
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group small {
            margin-top: 5px;
            color: #6c757d;
            font-size: 12px;
            font-style: italic;
        }

        .form-group input:required {
            border-left: 4px solid #0078d4;
        }

        .form-group input:invalid {
            border-color: #dc3545;
        }

        .form-group input:valid {
            border-color: #28a745;
        }

        /* Role and Signal Sections */
        .role-section,
        .signal-section {
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #f8f9fa;
        }

        .role-section h4,
        .signal-section h4 {
            margin-bottom: 15px;
            color: #0078d4;
            font-size: 1.1em;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 8px;
        }

        /* Form Validation Styles */
        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
        }

        .form-group.has-error input,
        .form-group.has-error textarea {
            border-color: #dc3545;
            background-color: #fff5f5;
        }

        .form-group.has-success input,
        .form-group.has-success textarea {
            border-color: #28a745;
        }

        /* Success Message */
        .success-message {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        /* Responsive Form */
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .form-group.full-width {
                grid-column: 1;
            }
        }

        /* Import Interface Styles */
        .import-interface {
            margin-top: 15px;
        }

        .import-section {
            margin-bottom: 20px;
        }

        .import-section h4 {
            margin-bottom: 15px;
            color: #0078d4;
            font-size: 1.1em;
        }

        .file-upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #fafafa;
            margin-bottom: 15px;
        }

        .file-upload-area:hover {
            border-color: #0078d4;
            background-color: #f0f8ff;
        }

        .file-upload-area.drag-over {
            border-color: #0078d4;
            background-color: #f0f8ff;
            transform: scale(1.02);
        }

        .upload-placeholder .upload-icon {
            font-size: 3em;
            display: block;
            margin-bottom: 15px;
            opacity: 0.6;
        }

        .upload-placeholder p {
            margin: 5px 0;
            color: #666;
        }

        .upload-placeholder strong {
            color: #0078d4;
        }

        .file-info {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .file-details {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .file-icon {
            font-size: 2em;
            opacity: 0.7;
        }

        .file-data {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        .file-stats {
            font-size: 0.9em;
            color: #6c757d;
        }

        .import-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .import-results {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
        }

        .import-results h4 {
            margin-bottom: 15px;
            color: #495057;
        }

        .import-summary {
            background-color: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .import-summary.success {
            border-color: #28a745;
            background-color: #d4edda;
            color: #155724;
        }

        .import-summary.warning {
            border-color: #ffc107;
            background-color: #fff3cd;
            color: #856404;
        }

        .import-summary.error {
            border-color: #dc3545;
            background-color: #f8d7da;
            color: #721c24;
        }

        .import-errors {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
        }

        .import-errors h5 {
            margin-bottom: 10px;
            color: #721c24;
        }

        .error-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .error-list li {
            padding: 5px 0;
            border-bottom: 1px solid #f5c6cb;
            color: #721c24;
            font-size: 0.9em;
        }

        .error-list li:last-child {
            border-bottom: none;
        }

        .import-preview {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 20px;
            margin-top: 20px;
        }

        .import-preview h4 {
            margin-bottom: 15px;
            color: #495057;
        }

        .preview-table-container {
            max-height: 300px;
            overflow: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            margin-bottom: 15px;
            background-color: white;
        }

        .preview-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .preview-table th,
        .preview-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            border-right: 1px solid #dee2e6;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .preview-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
        }

        .preview-table tr:hover {
            background-color: #f8f9fa;
        }

        .preview-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        /* Focus indicators */
        .btn:focus,
        input:focus,
        textarea:focus {
            outline: 2px solid #0078d4;
            outline-offset: 2px;
        }

        /* Print Styles */
        @media print {
            .tabs, .btn, .tree-actions, .step-actions {
                display: none !important;
            }
            
            .container {
                box-shadow: none;
                max-width: none;
                margin: 0;
            }
            
            .card {
                break-inside: avoid;
                margin-bottom: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <div class="header">
            <h1>Business Observability Factory</h1>
            <p>Demo Version - Visualize Process ‚Üí Steps ‚Üí Signals hierarchy and manage templates</p>
        </div>

        <!-- Demo Statistics -->
        <div class="demo-stats">
            <div class="stat-card">
                <div class="stat-number" id="process-count">0</div>
                <div class="stat-label">Business Processes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="step-count">0</div>
                <div class="stat-label">Total Steps</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="signal-count">0</div>
                <div class="stat-label">Signals Defined</div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab-button active" onclick="showTab('list')">
                üìã View Steps
            </button>
            <button class="tab-button" onclick="showTab('create')">
                ‚ûï Create Step
            </button>
            <button class="tab-button" onclick="showTab('import')">
                üì§ Import/Export
            </button>
        </div>

        <!-- Tab Content: Step List -->
        <div id="list-tab" class="tab-content active">
            <div class="section-header">
                <h2>Business Observability Hierarchy</h2>
                <button class="btn" onclick="createNewStep()">Create New Step</button>
            </div>
            
            <div class="card">
                <h3>Process ‚Üí Steps ‚Üí Signals Structure</h3>
                <div id="hierarchy-tree">
                    <!-- Tree will be populated by JavaScript from actual data -->
                    <div class="placeholder">
                        <h3>Loading business observability hierarchy...</h3>
                        <p>Tree structure will be generated from your data</p>
                    </div>
                </div>
                
                <div class="tree-legend">
                    <h4>Legend:</h4>
                    <div class="legend-items">
                        <span>üìã Business Process</span>
                        <span>üîπ Business Step</span>
                        <span>üìä Business Signals (KPI/Signal)</span>
                        <span>‚öôÔ∏è Process Signal</span>
                        <span>üñ•Ô∏è System Signal</span>
                    </div>
                </div>

                <div class="tree-actions">
                    <button class="btn btn-secondary" onclick="expandAll()">Expand All</button>
                    <button class="btn btn-secondary" onclick="collapseAll()">Collapse All</button>
                    <button class="btn btn-secondary" onclick="filterByProcess()">Filter by Process</button>
                </div>
            </div>

            <!-- Step Management Section -->
            <div class="card">
                <h3>Step Management</h3>
                <div class="section-header">
                    <h4>All Business Steps</h4>
                    <button class="btn" onclick="createNewStep()">‚ûï Add New Step</button>
                </div>
                
                <div id="step-list-table">
                    <!-- Step list table will be populated here -->
                    <div class="placeholder">
                        <h3>Loading step list...</h3>
                        <p>All business steps will appear here</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Content: Create/Edit Step -->
        <div id="create-tab" class="tab-content">
            <div class="section-header">
                <h2 id="form-title">Create Business Observability Step</h2>
                <div>
                    <button class="btn btn-secondary" onclick="cancelStepForm()">Cancel</button>
                    <button class="btn" onclick="saveStep()">üíæ Save Step</button>
                </div>
            </div>

            <!-- Step Form -->
            <div id="success-message" class="success-message">
                <strong>Success!</strong> Step saved successfully.
            </div>
            
            <form id="step-form" onsubmit="return false;">
                <!-- Form sections matching our 6-table structure -->
                <div class="card">
                    <h3>1. Process & Step Overview</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="businessProcessName">Business Process Name *</label>
                            <input type="text" id="businessProcessName" name="businessProcessName" required 
                                   placeholder="e.g., Loan Origination, Payment Processing">
                            <small>The high-level business process this step belongs to</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="businessProcessDescription">Business Process Description *</label>
                            <textarea id="businessProcessDescription" name="businessProcessDescription" required 
                                      placeholder="1-2 sentence description of what this business process accomplishes and why it matters"></textarea>
                            <small>Focus on business value and customer outcomes, not technical implementation</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="businessStepName">Business Step Name *</label>
                            <input type="text" id="businessStepName" name="businessStepName" required 
                                   placeholder="e.g., Validate Income, Process Payment">
                            <small>Use action-oriented language from business perspective</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="businessStepDescription">Business Step Description *</label>
                            <textarea id="businessStepDescription" name="businessStepDescription" required 
                                      placeholder="Detailed explanation of what this step accomplishes, its success criteria, and its role in the overall process"></textarea>
                            <small>Include what constitutes success/failure for this step</small>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>2. Role to Outcome Mapping</h3>
                    
                    <!-- Customer Role -->
                    <div class="role-section">
                        <h4>üë§ Customer Role</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="customerRoleValue">Customer Value</label>
                                <input type="text" id="customerRoleValue" name="customerRoleValue" 
                                       placeholder="e.g., Home loan applicant">
                            </div>
                            <div class="form-group">
                                <label for="customerGoalIntent">Goal/Intent</label>
                                <input type="text" id="customerGoalIntent" name="customerGoalIntent" 
                                       placeholder="What the customer is trying to accomplish">
                            </div>
                            <div class="form-group">
                                <label for="customerMappedKPIs">Mapped KPIs</label>
                                <input type="text" id="customerMappedKPIs" name="customerMappedKPIs" 
                                       placeholder="Which KPIs this role connects to">
                            </div>
                            <div class="form-group">
                                <label for="customerMappedSignals">Mapped Business Signals</label>
                                <input type="text" id="customerMappedSignals" name="customerMappedSignals" 
                                       placeholder="Which business signals this role connects to">
                            </div>
                        </div>
                    </div>

                    <!-- Internal User Role -->
                    <div class="role-section">
                        <h4>üîß Internal User Role</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="internalUserRoleValue">Internal User Value</label>
                                <input type="text" id="internalUserRoleValue" name="internalUserRoleValue" 
                                       placeholder="e.g., Document ingestion microservice">
                            </div>
                            <div class="form-group">
                                <label for="internalUserGoalIntent">Goal/Intent</label>
                                <input type="text" id="internalUserGoalIntent" name="internalUserGoalIntent" 
                                       placeholder="What this system is trying to accomplish">
                            </div>
                            <div class="form-group">
                                <label for="internalUserMappedKPIs">Mapped KPIs</label>
                                <input type="text" id="internalUserMappedKPIs" name="internalUserMappedKPIs" 
                                       placeholder="Which KPIs this system connects to">
                            </div>
                            <div class="form-group">
                                <label for="internalUserMappedSignals">Mapped Business Signals</label>
                                <input type="text" id="internalUserMappedSignals" name="internalUserMappedSignals" 
                                       placeholder="Which signals this system connects to">
                            </div>
                        </div>
                    </div>

                    <!-- Business Process Role -->
                    <div class="role-section">
                        <h4>‚öôÔ∏è Business Process Role</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="businessProcessRoleValue">Business Process Value</label>
                                <input type="text" id="businessProcessRoleValue" name="businessProcessRoleValue" 
                                       placeholder="e.g., Compliance dept via rules engine">
                            </div>
                            <div class="form-group">
                                <label for="businessProcessGoalIntent">Goal/Intent</label>
                                <input type="text" id="businessProcessGoalIntent" name="businessProcessGoalIntent" 
                                       placeholder="What business outcome this automation achieves">
                            </div>
                            <div class="form-group">
                                <label for="businessProcessMappedKPIs">Mapped KPIs</label>
                                <input type="text" id="businessProcessMappedKPIs" name="businessProcessMappedKPIs" 
                                       placeholder="Which KPIs this process connects to">
                            </div>
                            <div class="form-group">
                                <label for="businessProcessMappedSignals">Mapped Business Signals</label>
                                <input type="text" id="businessProcessMappedSignals" name="businessProcessMappedSignals" 
                                       placeholder="Which signals this process connects to">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>3. Business Outcome & Signal Definitions</h3>
                    
                    <!-- Business KPI -->
                    <div class="signal-section">
                        <h4>üìä Business KPI</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="businessKPIName">KPI Name</label>
                                <input type="text" id="businessKPIName" name="businessKPIName" 
                                       placeholder="e.g., Income Verification Pass Rate">
                            </div>
                            <div class="form-group">
                                <label for="businessKPITarget">Target/Threshold</label>
                                <input type="text" id="businessKPITarget" name="businessKPITarget" 
                                       placeholder="e.g., ‚â• 95%">
                            </div>
                            <div class="form-group full-width">
                                <label for="businessKPIFormula">Formula/Description</label>
                                <input type="text" id="businessKPIFormula" name="businessKPIFormula" 
                                       placeholder="e.g., (Passed Verifications / Total Verifications) √ó 100">
                            </div>
                        </div>
                    </div>

                    <!-- Business Signal -->
                    <div class="signal-section">
                        <h4>üìä Business Signal</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="businessSignalName">Signal Name</label>
                                <input type="text" id="businessSignalName" name="businessSignalName" 
                                       placeholder="e.g., Verification Outcome">
                            </div>
                            <div class="form-group">
                                <label for="businessSignalTarget">Target/Threshold</label>
                                <input type="text" id="businessSignalTarget" name="businessSignalTarget" 
                                       placeholder="e.g., N/A or specific threshold">
                            </div>
                            <div class="form-group full-width">
                                <label for="businessSignalDescription">Formula/Description</label>
                                <input type="text" id="businessSignalDescription" name="businessSignalDescription" 
                                       placeholder="e.g., Pass/fail result of income verification service">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>4. Technical Implementation</h3>
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label for="technicalFunctionDescription">Technical Function Description</label>
                            <textarea id="technicalFunctionDescription" name="technicalFunctionDescription" 
                                      placeholder="Describe what the system does behind the scenes in business-friendly terms"></textarea>
                            <small>What data is processed? What decisions are made? What external systems are called?</small>
                        </div>
                        
                        <div class="form-group full-width">
                            <label for="technicalFlow">Technical Flow</label>
                            <input type="text" id="technicalFlow" name="technicalFlow" 
                                   placeholder="System A ‚Üí (Protocol: Data Format) ‚Üí System B">
                            <small>Use format: "System A ‚Üí (Protocol: Data Format) ‚Üí System B"</small>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>5. Process Signal Definitions</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="processSignalName">Signal Name</label>
                            <input type="text" id="processSignalName" name="processSignalName" 
                                   placeholder="e.g., Income Parsed">
                        </div>
                        <div class="form-group">
                            <label for="processSignalComponent">Process Component</label>
                            <input type="text" id="processSignalComponent" name="processSignalComponent" 
                                   placeholder="e.g., Document Processing Workflow">
                        </div>
                        <div class="form-group">
                            <label for="processSignalCondition">Condition/Trigger</label>
                            <input type="text" id="processSignalCondition" name="processSignalCondition" 
                                   placeholder="e.g., OCR extraction completes">
                        </div>
                        <div class="form-group">
                            <label for="processSignalPurpose">Purpose/Interpretation</label>
                            <input type="text" id="processSignalPurpose" name="processSignalPurpose" 
                                   placeholder="e.g., Confirms structured data was extracted">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>6. System Signal Definitions</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="systemSignalName">Signal Name</label>
                            <input type="text" id="systemSignalName" name="systemSignalName" 
                                   placeholder="e.g., OCR Container Liveness">
                        </div>
                        <div class="form-group">
                            <label for="systemSignalComponent">System Component</label>
                            <input type="text" id="systemSignalComponent" name="systemSignalComponent" 
                                   placeholder="e.g., Document Parsing Service">
                        </div>
                        <div class="form-group">
                            <label for="systemSignalCondition">Condition/Trigger</label>
                            <input type="text" id="systemSignalCondition" name="systemSignalCondition" 
                                   placeholder="e.g., Container healthcheck fails">
                        </div>
                        <div class="form-group">
                            <label for="systemSignalPurpose">Purpose/Interpretation</label>
                            <input type="text" id="systemSignalPurpose" name="systemSignalPurpose" 
                                   placeholder="e.g., Service is down or unresponsive">
                        </div>
                    </div>
                </div>

                <!-- Hidden field for edit mode -->
                <input type="hidden" id="editStepId" name="editStepId">
                <input type="hidden" id="editProcessId" name="editProcessId">
            </form>
        </div>

        <!-- Tab Content: Import/Export -->
        <div id="import-tab" class="tab-content">
            <div class="section-header">
                <h2>Import & Export</h2>
                <span class="status status-ready">CSV Ready</span>
            </div>

            <div class="card">
                <h3>Export Steps</h3>
                <p>Download all your business observability steps as a CSV file.</p>
                <button class="btn" onclick="exportAllSteps()">üì• Export All Steps to CSV</button>
            </div>

            <div class="card">
                <h3>Import Steps</h3>
                <p>Upload a CSV file to import multiple steps at once.</p>
                
                <!-- File Upload Interface -->
                <div class="import-interface">
                    <div class="import-section">
                        <h4>üìÅ Select CSV File</h4>
                        <div class="file-upload-area" id="file-upload-area" onclick="document.getElementById('csv-file-input').click()">
                            <div class="upload-placeholder">
                                <span class="upload-icon">üìÑ</span>
                                <p><strong>Click to select CSV file</strong></p>
                                <p><small>Or drag and drop your CSV file here</small></p>
                                <p><small>Supported: .csv files up to 5MB</small></p>
                            </div>
                        </div>
                        <input type="file" id="csv-file-input" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
                        
                        <div id="file-info" class="file-info" style="display: none;">
                            <div class="file-details">
                                <span class="file-icon">üìÑ</span>
                                <div class="file-data">
                                    <div class="file-name" id="selected-file-name"></div>
                                    <div class="file-stats" id="selected-file-stats"></div>
                                </div>
                                <button class="btn btn-small btn-secondary" onclick="clearFileSelection()">‚úï Remove</button>
                            </div>
                        </div>
                    </div>

                    <!-- Import Actions -->
                    <div class="import-actions">
                        <button class="btn" id="import-btn" onclick="processImport()" disabled>
                            üì• Import Steps from CSV
                        </button>
                        <button class="btn btn-secondary" onclick="downloadCSVTemplate()">
                            üìÑ Download CSV Template
                        </button>
                        <button class="btn btn-secondary" onclick="downloadSampleCSV()">
                            üìã Download Sample CSV
                        </button>
                    </div>

                    <!-- Import Results -->
                    <div id="import-results" class="import-results" style="display: none;">
                        <h4>Import Results</h4>
                        <div id="import-summary" class="import-summary"></div>
                        <div id="import-errors" class="import-errors" style="display: none;"></div>
                    </div>

                    <!-- Import Preview -->
                    <div id="import-preview" class="import-preview" style="display: none;">
                        <h4>Import Preview <small>(First 3 rows)</small></h4>
                        <div class="preview-table-container">
                            <table id="preview-table" class="preview-table"></table>
                        </div>
                        <div class="preview-actions">
                            <button class="btn" onclick="confirmImport()">‚úÖ Confirm Import</button>
                            <button class="btn btn-secondary" onclick="cancelImport()">‚ùå Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Demo Data</h3>
                <p>Load sample business observability steps to explore the application.</p>
                <button class="btn btn-secondary" onclick="loadDemoData()">üîÑ Load Demo Data</button>
                <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let bosFactory;
        let selectedFile = null;
        let parsedData = null;
        let autoSaveTimeout = null;

        // Data Model & Storage Functions
        class BOSFactory {
            constructor() {
                this.storageKey = 'bos-factory-data';
                this.data = this.loadData();
            }

            getDefaultData() {
                return {
                    processes: {},
                    metadata: {
                        version: '1.0',
                        created: new Date().toISOString(),
                        lastModified: new Date().toISOString()
                    }
                };
            }

            loadData() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    return stored ? JSON.parse(stored) : this.getDefaultData();
                } catch (error) {
                    console.warn('Error loading data, using defaults:', error);
                    return this.getDefaultData();
                }
            }

            saveData() {
                try {
                    this.data.metadata.lastModified = new Date().toISOString();
                    localStorage.setItem(this.storageKey, JSON.stringify(this.data));
                    return true;
                } catch (error) {
                    console.error('Error saving data:', error);
                    return false;
                }
            }

            getProcesses() {
                return this.data.processes || {};
            }

            getProcess(processId) {
                return this.data.processes[processId] || null;
            }

            getAllSteps() {
                const steps = [];
                Object.values(this.data.processes).forEach(process => {
                    Object.entries(process.steps).forEach(([stepId, step]) => {
                        steps.push({
                            ...step,
                            processName: process.name,
                            stepId: stepId
                        });
                    });
                });
                return steps;
            }

            getStats() {
                const processes = Object.keys(this.data.processes).length;
                const steps = this.getAllSteps().length;
                const signals = this.getAllSteps().reduce((count, step) => {
                    return count + 4;
                }, 0);

                return { processes, steps, signals };
            }

            initializeSampleData() {
                this.data = {
                    processes: {
                        'loan-origination': {
                            name: 'Loan Origination',
                            description: 'Deliver approved loan funds to qualified applicants in a timely, compliant, and efficient manner.',
                            steps: {
                                'validate-income': {
                                    businessProcessName: 'Loan Origination',
                                    businessProcessDescription: 'Deliver approved loan funds to qualified applicants in a timely, compliant, and efficient manner. Supports revenue generation and customer trust while managing risk and operational cost.',
                                    businessStepName: 'Validate Income',
                                    businessStepDescription: 'Ensure borrower income is accurate and meets policy requirements, reducing risk of default or misrepresentation. Success means income documentation is complete, verified, and meets minimum policy thresholds.',
                                    
                                    customerRole: {
                                        type: 'Customer',
                                        value: 'Home loan applicant',
                                        goalIntent: 'Receive a quick decision and clear communication',
                                        mappedKPIs: 'Income Verification Pass Rate',
                                        mappedSignals: 'Verification Outcome'
                                    },
                                    internalUserRole: {
                                        type: 'Internal User',
                                        value: 'Document ingestion microservice',
                                        goalIntent: 'Parse and extract income data from uploaded files',
                                        mappedKPIs: 'Document Completeness Score',
                                        mappedSignals: 'Income Documentation Flag'
                                    },
                                    businessProcessRole: {
                                        type: 'Business Process',
                                        value: 'Compliance dept via rules engine',
                                        goalIntent: 'Enforce income-related risk policy',
                                        mappedKPIs: '(Implied via signal logic)',
                                        mappedSignals: 'Risk Threshold Triggered, Verification Outcome'
                                    },

                                    businessKPI: {
                                        name: 'Income Verification Pass Rate',
                                        targetThreshold: '‚â• 95%',
                                        formulaDescription: '(Passed Verifications / Total Verifications) √ó 100'
                                    },
                                    businessSignal: {
                                        name: 'Verification Outcome',
                                        targetThreshold: 'N/A',
                                        formulaDescription: 'Pass/fail result of income verification service'
                                    },

                                    technicalFunctionDescription: 'Parse uploaded income documents using OCR, extract structured income data, and forward to rule engine for policy validation against minimum requirements.',
                                    technicalFlow: 'Web App ‚Üí (POST: PDF) ‚Üí OCR Service ‚Üí (Kafka: Parsed JSON) ‚Üí Rules Engine',

                                    processSignal: {
                                        name: 'Income Parsed',
                                        component: 'Document Processing Workflow',
                                        conditionTrigger: 'OCR extraction completes',
                                        purposeInterpretation: 'Confirms structured income data was successfully extracted from documents'
                                    },

                                    systemSignal: {
                                        name: 'OCR Container Liveness',
                                        component: 'Document Parsing Service',
                                        conditionTrigger: 'Container healthcheck fails',
                                        purposeInterpretation: 'OCR service is down or unresponsive, blocking income validation'
                                    }
                                }
                            }
                        },
                        'payment-processing': {
                            name: 'Payment Processing',
                            description: 'Process customer payments securely and efficiently while maintaining compliance and fraud protection.',
                            steps: {
                                'validate-payment': {
                                    businessProcessName: 'Payment Processing',
                                    businessProcessDescription: 'Process customer payments securely and efficiently while maintaining compliance and fraud protection.',
                                    businessStepName: 'Validate Payment',
                                    businessStepDescription: 'Validate payment information, verify customer identity, and check for fraud indicators before processing.',
                                    
                                    businessKPI: {
                                        name: 'Payment Validation Rate',
                                        targetThreshold: '‚â• 99%',
                                        formulaDescription: '(Valid Payments / Total Payment Attempts) √ó 100'
                                    },
                                    businessSignal: {
                                        name: 'Payment Status',
                                        targetThreshold: 'N/A',
                                        formulaDescription: 'Real-time validation status of payment attempt'
                                    },
                                    processSignal: {
                                        name: 'Payment Validated',
                                        component: 'Payment Validation Workflow',
                                        conditionTrigger: 'Validation checks complete',
                                        purposeInterpretation: 'Confirms payment has passed all validation checks'
                                    },
                                    systemSignal: {
                                        name: 'Payment Gateway Health',
                                        component: 'Payment Gateway Service',
                                        conditionTrigger: 'Gateway response time > 5 seconds',
                                        purposeInterpretation: 'Payment gateway is experiencing performance issues'
                                    }
                                }
                            }
                        }
                    },
                    metadata: {
                        version: '1.0',
                        created: new Date().toISOString(),
                        lastModified: new Date().toISOString()
                    }
                };
                this.saveData();
            }

            clearData() {
                this.data = this.getDefaultData();
                this.saveData();
            }

            deleteStep(processId, stepId) {
                if (this.data.processes[processId] && this.data.processes[processId].steps[stepId]) {
                    delete this.data.processes[processId].steps[stepId];
                    
                    if (Object.keys(this.data.processes[processId].steps).length === 0) {
                        delete this.data.processes[processId];
                    }
                    
                    this.saveData();
                    return true;
                }
                return false;
            }

            addStep(processName, stepData) {
                const processId = this.generateProcessId(processName);
                const stepId = stepData.stepId || this.generateStepId();
                
                if (!this.data.processes[processId]) {
                    this.data.processes[processId] = {
                        name: processName,
                        description: stepData.businessProcessDescription || '',
                        steps: {}
                    };
                }
                
                if (stepData.businessProcessDescription) {
                    this.data.processes[processId].description = stepData.businessProcessDescription;
                }
                
                this.data.processes[processId].steps[stepId] = {
                    ...stepData,
                    lastModified: new Date().toISOString()
                };
                
                this.saveData();
                return { processId, stepId };
            }

            generateProcessId(processName) {
                return processName.toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/^-+|-+$/g, '');
            }

            generateStepId() {
                return 'step-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            }

            exportToCSV() {
                const steps = this.getAllSteps();
                
                if (steps.length === 0) {
                    return null;
                }

                const headers = [
                    'step_id', 'business_process_name', 'business_process_description', 
                    'business_step_name', 'business_step_description',
                    'customer_role_value', 'customer_role_goal', 'customer_role_mapped_kpis', 'customer_role_mapped_signals',
                    'internal_user_role_value', 'internal_user_role_goal', 'internal_user_role_mapped_kpis', 'internal_user_role_mapped_signals',
                    'business_process_role_value', 'business_process_role_goal', 'business_process_role_mapped_kpis', 'business_process_role_mapped_signals',
                    'business_kpi_name', 'business_kpi_target', 'business_kpi_formula',
                    'business_signal_name', 'business_signal_target', 'business_signal_description',
                    'technical_function_description', 'technical_flow',
                    'process_signal_name', 'process_signal_component', 'process_signal_condition', 'process_signal_purpose',
                    'system_signal_name', 'system_signal_component', 'system_signal_condition', 'system_signal_purpose',
                    'last_modified'
                ];

                const rows = steps.map(step => {
                    return [
                        step.stepId || '', step.businessProcessName || '', step.businessProcessDescription || '',
                        step.businessStepName || '', step.businessStepDescription || '',
                        step.customerRole?.value || '', step.customerRole?.goalIntent || '', step.customerRole?.mappedKPIs || '', step.customerRole?.mappedSignals || '',
                        step.internalUserRole?.value || '', step.internalUserRole?.goalIntent || '', step.internalUserRole?.mappedKPIs || '', step.internalUserRole?.mappedSignals || '',
                        step.businessProcessRole?.value || '', step.businessProcessRole?.goalIntent || '', step.businessProcessRole?.mappedKPIs || '', step.businessProcessRole?.mappedSignals || '',
                        step.businessKPI?.name || '', step.businessKPI?.targetThreshold || '', step.businessKPI?.formulaDescription || '',
                        step.businessSignal?.name || '', step.businessSignal?.targetThreshold || '', step.businessSignal?.formulaDescription || '',
                        step.technicalFunctionDescription || '', step.technicalFlow || '',
                        step.processSignal?.name || '', step.processSignal?.component || '', step.processSignal?.conditionTrigger || '', step.processSignal?.purposeInterpretation || '',
                        step.systemSignal?.name || '', step.systemSignal?.component || '', step.systemSignal?.conditionTrigger || '', step.systemSignal?.purposeInterpretation || '',
                        step.lastModified || new Date().toISOString()
                    ];
                });

                const csvData = [headers, ...rows];
                
                return csvData.map(row => 
                    row.map(field => {
                        const stringField = String(field);
                        if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
                            return '"' + stringField.replace(/"/g, '""') + '"';
                        }
                        return stringField;
                    }).join(',')
                ).join('\n');
            }

            getCSVTemplate() {
                const headers = [
                    'step_id', 'business_process_name', 'business_process_description', 
                    'business_step_name', 'business_step_description',
                    'customer_role_value', 'customer_role_goal', 'customer_role_mapped_kpis', 'customer_role_mapped_signals',
                    'internal_user_role_value', 'internal_user_role_goal', 'internal_user_role_mapped_kpis', 'internal_user_role_mapped_signals',
                    'business_process_role_value', 'business_process_role_goal', 'business_process_role_mapped_kpis', 'business_process_role_mapped_signals',
                    'business_kpi_name', 'business_kpi_target', 'business_kpi_formula',
                    'business_signal_name', 'business_signal_target', 'business_signal_description',
                    'technical_function_description', 'technical_flow',
                    'process_signal_name', 'process_signal_component', 'process_signal_condition', 'process_signal_purpose',
                    'system_signal_name', 'system_signal_component', 'system_signal_condition', 'system_signal_purpose',
                    'last_modified'
                ];

                const sampleRow = [
                    'step-example-001', 'Loan Origination', 'Process loan applications from submission to approval',
                    'Validate Income', 'Verify borrower income meets policy requirements',
                    'Home loan applicant', 'Receive quick decision', 'Income Verification Pass Rate', 'Verification Outcome',
                    'Document processing service', 'Extract income data', 'Document Completeness Score', 'Income Documentation Flag',
                    'Compliance rules engine', 'Enforce risk policy', 'Policy Compliance Rate', 'Risk Threshold Triggered',
                    'Income Verification Pass Rate', '‚â• 95%', '(Passed / Total) √ó 100',
                    'Verification Outcome', 'N/A', 'Pass/fail result of verification',
                    'Parse documents using OCR and validate against policy rules', 'Web App ‚Üí OCR Service ‚Üí Rules Engine',
                    'Income Parsed', 'Document Processing Workflow', 'OCR extraction completes', 'Confirms data was extracted',
                    'OCR Container Liveness', 'Document Parsing Service', 'Container healthcheck fails', 'Service is down or unresponsive',
                    new Date().toISOString()
                ];

                return [headers, sampleRow].map(row => 
                    row.map(field => {
                        const stringField = String(field);
                        if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
                            return '"' + stringField.replace(/"/g, '""') + '"';
                        }
                        return stringField;
                    }).join(',')
                ).join('\n');
            }

            getStep(processId, stepId) {
                if (this.data.processes[processId] && this.data.processes[processId].steps[stepId]) {
                    return {
                        ...this.data.processes[processId].steps[stepId],
                        processId,
                        stepId
                    };
                }
                return null;
            }
        }

        // UI Functions
        function showToast(message, type = 'info', duration = 3000) {
            try {
                const toastHTML = `
                    <div class="toast-message ${type}" id="toast-${Date.now()}">
                        ${message}
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', toastHTML);
                
                setTimeout(() => {
                    const toasts = document.querySelectorAll('.toast-message');
                    if (toasts.length > 0) {
                        toasts[0].remove();
                    }
                }, duration);
            } catch (error) {
                console.warn('Toast notification failed:', error);
                alert(message);
            }
        }

        function showLoading(message = 'Processing...') {
            try {
                const loadingHTML = `
                    <div class="loading-overlay" id="loading-overlay">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <div class="loading-text">${message}</div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', loadingHTML);
            } catch (error) {
                console.warn('Show loading failed:', error);
            }
        }

        function hideLoading() {
            try {
                const overlay = document.getElementById('loading-overlay');
                if (overlay) {
                    overlay.remove();
                }
            } catch (error) {
                console.warn('Hide loading failed:', error);
            }
        }

        function setButtonLoading(button, loading = true) {
            try {
                if (!button) return;
                
                if (loading) {
                    if (!button.dataset.originalText) {
                        button.dataset.originalText = button.textContent;
                    }
                    button.classList.add('processing');
                    button.disabled = true;
                } else {
                    button.classList.remove('processing');
                    button.disabled = false;
                    if (button.dataset.originalText) {
                        button.textContent = button.dataset.originalText;
                        delete button.dataset.originalText;
                    }
                }
            } catch (error) {
                console.warn('Set button loading failed:', error);
            }
        }

        // Tab Management
        function showTab(tabName) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => {
                content.classList.remove('active');
            });

            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });

            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }

            const clickedButton = event ? event.target : document.querySelector(`button[onclick="showTab('${tabName}')"]`);
            if (clickedButton) {
                clickedButton.classList.add('active');
            }

            if (tabName === 'list') {
                updateDemoStats();
                renderHierarchyTree();
                renderStepList();
            }
            
            if (tabName === 'import') {
                updateExportStats();
            }
            
            if (tabName === 'create') {
                const isEditing = document.getElementById('editStepId').value;
                if (!isEditing) {
                    clearStepForm();
                }
            }
        }

        // Demo Statistics
        function updateDemoStats() {
            const stats = bosFactory.getStats();
            
            const processCount = document.getElementById('process-count');
            const stepCount = document.getElementById('step-count');
            const signalCount = document.getElementById('signal-count');
            
            if (processCount) processCount.textContent = stats.processes;
            if (stepCount) stepCount.textContent = stats.steps;
            if (signalCount) signalCount.textContent = stats.signals;
        }

        // Render the hierarchy tree from actual data
        function renderHierarchyTree() {
            const hierarchyContainer = document.getElementById('hierarchy-tree');
            if (!hierarchyContainer) return;
            
            const processes = bosFactory.getProcesses();
            let treeHTML = '';

            Object.entries(processes).forEach(([processId, process], processIndex, processArray) => {
                const isLastProcess = processIndex === processArray.length - 1;
                
                treeHTML += `üìã <strong>${process.name}</strong>\n`;
                
                const steps = Object.entries(process.steps);
                steps.forEach(([stepId, step], stepIndex) => {
                    const isLastStep = stepIndex === steps.length - 1;
                    const stepPrefix = isLastProcess && isLastStep ? '‚îî‚îÄ‚îÄ ' : '‚îú‚îÄ‚îÄ ';
                    const signalPrefix = isLastProcess && isLastStep ? '    ' : '‚îÇ   ';
                    
                    treeHTML += `${stepPrefix}üîπ <span class="step-name">${step.businessStepName}</span>\n`;
                    
                    if (step.businessKPI) {
                        treeHTML += `${signalPrefix}‚îú‚îÄ‚îÄ üìä ${step.businessKPI.name} (Business KPI)\n`;
                    }
                    if (step.businessSignal) {
                        treeHTML += `${signalPrefix}‚îú‚îÄ‚îÄ üìä ${step.businessSignal.name} (Business Signal)\n`;
                    }
                    if (step.processSignal) {
                        treeHTML += `${signalPrefix}‚îú‚îÄ‚îÄ ‚öôÔ∏è ${step.processSignal.name} (Process Signal)\n`;
                    }
                    if (step.systemSignal) {
                        treeHTML += `${signalPrefix}‚îî‚îÄ‚îÄ üñ•Ô∏è ${step.systemSignal.name} (System Signal)\n`;
                    }
                });
                
                if (!isLastProcess) {
                    treeHTML += '\n';
                }
            });

            hierarchyContainer.innerHTML = `<pre class="tree-display">${treeHTML}</pre>`;
        }

        // Render step list table
        function renderStepList() {
            const container = document.getElementById('step-list-table');
            if (!container) return;
            
            const steps = bosFactory.getAllSteps();
            
            if (steps.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <h3>No steps found</h3>
                        <p>Create your first business observability step to get started</p>
                        <button class="btn" onclick="createNewStep()">Create New Step</button>
                    </div>
                `;
                return;
            }

            let tableHTML = `
                <table class="step-table">
                    <thead>
                        <tr>
                            <th>Business Process</th>
                            <th>Step Name</th>
                            <th>Signals</th>
                            <th>Last Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            steps.forEach(step => {
                const signalCount = [
                    step.businessKPI?.name,
                    step.businessSignal?.name,
                    step.processSignal?.name,
                    step.systemSignal?.name
                ].filter(Boolean).length;

                const lastUpdated = new Date().toLocaleDateString();

                tableHTML += `
                    <tr class="step-row">
                        <td><span class="step-process">${step.processName}</span></td>
                        <td><span class="step-name-cell">${step.businessStepName}</span></td>
                        <td><span class="step-signals">${signalCount} signals defined</span></td>
                        <td><span class="step-updated">${lastUpdated}</span></td>
                        <td>
                            <div class="step-actions">
                                <button class="btn btn-small" onclick="editStep('${step.stepId}')">‚úèÔ∏è Edit</button>
                                <button class="btn btn-small btn-secondary" onclick="viewStep('${step.stepId}')">üëÅÔ∏è View</button>
                                <button class="btn btn-small btn-danger" onclick="confirmDeleteStep('${step.stepId}', '${step.businessStepName}')">üóëÔ∏è Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        // Step Management Functions
        function confirmDeleteStep(stepId, stepName) {
            const dialogHTML = `
                <div class="confirm-dialog" id="delete-confirm">
                    <div class="confirm-content">
                        <h3>üóëÔ∏è Delete Step</h3>
                        <p>Are you sure you want to delete the step "<strong>${stepName}</strong>"?</p>
                        <p><small>This action cannot be undone and will remove all associated signals.</small></p>
                        <div class="confirm-actions">
                            <button class="btn btn-danger" onclick="executeDeleteStep('${stepId}')">Delete</button>
                            <button class="btn btn-secondary" onclick="cancelDelete()">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', dialogHTML);
        }

        function executeDeleteStep(stepId) {
            const steps = bosFactory.getAllSteps();
            const stepToDelete = steps.find(s => s.stepId === stepId);
            
            if (stepToDelete) {
                const processes = bosFactory.getProcesses();
                let processId = null;
                
                Object.entries(processes).forEach(([pId, process]) => {
                    if (process.steps[stepId]) {
                        processId = pId;
                    }
                });
                
                if (processId) {
                    const success = bosFactory.deleteStep(processId, stepId);
                    if (success) {
                        updateDemoStats();
                        renderHierarchyTree();
                        renderStepList();
                        
                        showToast(`‚úÖ Step "${stepToDelete.businessStepName}" deleted successfully!`, 'success');
                    } else {
                        showToast('‚ùå Error deleting step. Please try again.', 'error');
                    }
                }
            }
            
            cancelDelete();
        }

        function cancelDelete() {
            const dialog = document.getElementById('delete-confirm');
            if (dialog) {
                dialog.remove();
            }
        }

        function editStep(stepId) {
            const steps = bosFactory.getAllSteps();
            const step = steps.find(s => s.stepId === stepId);
            
            if (!step) {
                alert('Step not found');
                return;
            }

            const processes = bosFactory.getProcesses();
            let processId = null;
            Object.entries(processes).forEach(([pId, process]) => {
                if (process.steps[stepId]) {
                    processId = pId;
                }
            });

            if (!processId) {
                alert('Process not found for step');
                return;
            }

            populateStepForm(step, processId, stepId);
            
            document.getElementById('form-title').textContent = `Edit Step: ${step.businessStepName}`;
            showTab('create');
        }

        function viewStep(stepId) {
            const steps = bosFactory.getAllSteps();
            const step = steps.find(s => s.stepId === stepId);
            if (step) {
                alert(`Viewing step: ${step.businessStepName}\nProcess: ${step.processName}\n\nFull view functionality will be implemented in next phase.`);
            }
        }

        // Form Management
        function populateStepForm(step, processId, stepId) {
            document.getElementById('editStepId').value = stepId || '';
            document.getElementById('editProcessId').value = processId || '';

            document.getElementById('businessProcessName').value = step.businessProcessName || '';
            document.getElementById('businessProcessDescription').value = step.businessProcessDescription || '';
            document.getElementById('businessStepName').value = step.businessStepName || '';
            document.getElementById('businessStepDescription').value = step.businessStepDescription || '';

            if (step.customerRole) {
                document.getElementById('customerRoleValue').value = step.customerRole.value || '';
                document.getElementById('customerGoalIntent').value = step.customerRole.goalIntent || '';
                document.getElementById('customerMappedKPIs').value = step.customerRole.mappedKPIs || '';
                document.getElementById('customerMappedSignals').value = step.customerRole.mappedSignals || '';
            }

            if (step.internalUserRole) {
                document.getElementById('internalUserRoleValue').value = step.internalUserRole.value || '';
                document.getElementById('internalUserGoalIntent').value = step.internalUserRole.goalIntent || '';
                document.getElementById('internalUserMappedKPIs').value = step.internalUserRole.mappedKPIs || '';
                document.getElementById('internalUserMappedSignals').value = step.internalUserRole.mappedSignals || '';
            }

            if (step.businessProcessRole) {
                document.getElementById('businessProcessRoleValue').value = step.businessProcessRole.value || '';
                document.getElementById('businessProcessGoalIntent').value = step.businessProcessRole.goalIntent || '';
                document.getElementById('businessProcessMappedKPIs').value = step.businessProcessRole.mappedKPIs || '';
                document.getElementById('businessProcessMappedSignals').value = step.businessProcessRole.mappedSignals || '';
            }

            if (step.businessKPI) {
                document.getElementById('businessKPIName').value = step.businessKPI.name || '';
                document.getElementById('businessKPITarget').value = step.businessKPI.targetThreshold || '';
                document.getElementById('businessKPIFormula').value = step.businessKPI.formulaDescription || '';
            }

            if (step.businessSignal) {
                document.getElementById('businessSignalName').value = step.businessSignal.name || '';
                document.getElementById('businessSignalTarget').value = step.businessSignal.targetThreshold || '';
                document.getElementById('businessSignalDescription').value = step.businessSignal.formulaDescription || '';
            }

            document.getElementById('technicalFunctionDescription').value = step.technicalFunctionDescription || '';
            document.getElementById('technicalFlow').value = step.technicalFlow || '';

            if (step.processSignal) {
                document.getElementById('processSignalName').value = step.processSignal.name || '';
                document.getElementById('processSignalComponent').value = step.processSignal.component || '';
                document.getElementById('processSignalCondition').value = step.processSignal.conditionTrigger || '';
                document.getElementById('processSignalPurpose').value = step.processSignal.purposeInterpretation || '';
            }

            if (step.systemSignal) {
                document.getElementById('systemSignalName').value = step.systemSignal.name || '';
                document.getElementById('systemSignalComponent').value = step.systemSignal.component || '';
                document.getElementById('systemSignalCondition').value = step.systemSignal.conditionTrigger || '';
                document.getElementById('systemSignalPurpose').value = step.systemSignal.purposeInterpretation || '';
            }
        }

        function clearStepForm() {
            document.getElementById('step-form').reset();
            document.getElementById('editStepId').value = '';
            document.getElementById('editProcessId').value = '';
            document.getElementById('form-title').textContent = 'Create Business Observability Step';
            
            document.querySelectorAll('.form-group').forEach(group => {
                group.classList.remove('has-error', 'has-success');
            });
            
            document.querySelectorAll('.error-message').forEach(msg => msg.remove());
            
            document.getElementById('success-message').style.display = 'none';
        }

        function createNewStep() {
            clearStepForm();
            showTab('create');
        }

        function cancelStepForm() {
            if (confirm('Are you sure you want to cancel? Any unsaved changes will be lost.')) {
                clearStepForm();
                showTab('list');
            }
        }

        // Form validation
        function validateStepForm() {
            const errors = [];
            
            document.querySelectorAll('.form-group').forEach(group => {
                group.classList.remove('has-error');
            });
            
            const requiredFields = [
                { id: 'businessProcessName', name: 'Business Process Name' },
                { id: 'businessProcessDescription', name: 'Business Process Description' },
                { id: 'businessStepName', name: 'Business Step Name' },
                { id: 'businessStepDescription', name: 'Business Step Description' }
            ];

            requiredFields.forEach(field => {
                const element = document.getElementById(field.id);
                const formGroup = element.closest('.form-group');
                
                if (!element.value.trim()) {
                    errors.push(`${field.name} is required`);
                    formGroup.classList.add('has-error');
                    
                    let errorMsg = formGroup.querySelector('.error-message');
                    if (!errorMsg) {
                        errorMsg = document.createElement('div');
                        errorMsg.className = 'error-message';
                        formGroup.appendChild(errorMsg);
                    }
                    errorMsg.textContent = 'This field is required';
                } else {
                    formGroup.classList.remove('has-error');
                    formGroup.classList.add('has-success');
                    
                    const errorMsg = formGroup.querySelector('.error-message');
                    if (errorMsg) {
                        errorMsg.remove();
                    }
                }
            });

            if (errors.length > 0) {
                const firstError = document.querySelector('.has-error');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return false;
            }

            return true;
        }

        // Save step function
        function saveStep() {
            if (!validateStepForm()) {
                showToast('‚ùå Please fix the validation errors before saving', 'error');
                return;
            }

            const saveBtn = document.querySelector('button[onclick="saveStep()"]');
            setButtonLoading(saveBtn, true);
            showLoading('Saving step...');

            try {
                const formData = collectFormData();
                
                const result = bosFactory.addStep(formData.businessProcessName, formData);
                
                setTimeout(() => {
                    hideLoading();
                    setButtonLoading(saveBtn, false);
                    
                    const successDiv = document.getElementById('success-message');
                    successDiv.style.display = 'block';
                    successDiv.innerHTML = `<strong>Success!</strong> Step "${formData.businessStepName}" saved successfully.`;
                    
                    showToast(`‚úÖ Step "${formData.businessStepName}" saved successfully!`, 'success');
                    
                    updateDemoStats();
                    renderHierarchyTree();
                    renderStepList();
                    
                    setTimeout(() => {
                        successDiv.style.display = 'none';
                        clearStepForm();
                        showTab('list');
                    }, 2000);
                }, 500);
                
            } catch (error) {
                hideLoading();
                setButtonLoading(saveBtn, false);
                console.error('Error saving step:', error);
                showToast('‚ùå Error saving step: ' + error.message, 'error');
            }
        }

        function collectFormData() {
            const editStepId = document.getElementById('editStepId').value;
            
            return {
                stepId: editStepId || undefined,
                
                businessProcessName: document.getElementById('businessProcessName').value.trim(),
                businessProcessDescription: document.getElementById('businessProcessDescription').value.trim(),
                businessStepName: document.getElementById('businessStepName').value.trim(),
                businessStepDescription: document.getElementById('businessStepDescription').value.trim(),
                
                customerRole: {
                    type: 'Customer',
                    value: document.getElementById('customerRoleValue').value.trim(),
                    goalIntent: document.getElementById('customerGoalIntent').value.trim(),
                    mappedKPIs: document.getElementById('customerMappedKPIs').value.trim(),
                    mappedSignals: document.getElementById('customerMappedSignals').value.trim()
                },
                internalUserRole: {
                    type: 'Internal User',
                    value: document.getElementById('internalUserRoleValue').value.trim(),
                    goalIntent: document.getElementById('internalUserGoalIntent').value.trim(),
                    mappedKPIs: document.getElementById('internalUserMappedKPIs').value.trim(),
                    mappedSignals: document.getElementById('internalUserMappedSignals').value.trim()
                },
                businessProcessRole: {
                    type: 'Business Process',
                    value: document.getElementById('businessProcessRoleValue').value.trim(),
                    goalIntent: document.getElementById('businessProcessGoalIntent').value.trim(),
                    mappedKPIs: document.getElementById('businessProcessMappedKPIs').value.trim(),
                    mappedSignals: document.getElementById('businessProcessMappedSignals').value.trim()
                },

                businessKPI: {
                    name: document.getElementById('businessKPIName').value.trim(),
                    targetThreshold: document.getElementById('businessKPITarget').value.trim(),
                    formulaDescription: document.getElementById('businessKPIFormula').value.trim()
                },
                businessSignal: {
                    name: document.getElementById('businessSignalName').value.trim(),
                    targetThreshold: document.getElementById('businessSignalTarget').value.trim(),
                    formulaDescription: document.getElementById('businessSignalDescription').value.trim()
                },

                technicalFunctionDescription: document.getElementById('technicalFunctionDescription').value.trim(),
                technicalFlow: document.getElementById('technicalFlow').value.trim(),

                processSignal: {
                    name: document.getElementById('processSignalName').value.trim(),
                    component: document.getElementById('processSignalComponent').value.trim(),
                    conditionTrigger: document.getElementById('processSignalCondition').value.trim(),
                    purposeInterpretation: document.getElementById('processSignalPurpose').value.trim()
                },

                systemSignal: {
                    name: document.getElementById('systemSignalName').value.trim(),
                    component: document.getElementById('systemSignalComponent').value.trim(),
                    conditionTrigger: document.getElementById('systemSignalCondition').value.trim(),
                    purposeInterpretation: document.getElementById('systemSignalPurpose').value.trim()
                }
            };
        }

        // Export and Import Functions
        function updateExportStats() {
            // Safe to call - will only update if elements exist
        }

        function exportAllSteps() {
            console.log('Export function called');
            
            try {
                const csvData = bosFactory.exportToCSV();
                console.log('CSV data generated:', csvData ? `${csvData.length} characters` : 'null');
                
                if (!csvData) {
                    alert('No steps to export. Create some steps first!');
                    return;
                }

                const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
                console.log('Blob created:', blob.size, 'bytes');
                
                const link = document.createElement('a');
                
                if (link.download !== undefined) {
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    const filename = `bos-factory-steps-${timestamp}.csv`;
                    console.log('Filename:', filename);
                    
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    
                    const exportBtn = document.querySelector('button[onclick="exportAllSteps()"]');
                    if (exportBtn) {
                        exportBtn.classList.add('downloading');
                        exportBtn.textContent = 'üì• Downloading...';
                        console.log('Button animation started');
                    }
                    
                    console.log('Triggering download...');
                    link.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        
                        if (exportBtn) {
                            exportBtn.classList.remove('downloading');
                            exportBtn.textContent = 'üì• Export All Steps to CSV';
                        }
                        
                        const message = `Successfully exported ${bosFactory.getStats().steps} steps to ${filename}`;
                        console.log(message);
                        showToast(`‚úÖ Exported ${bosFactory.getStats().steps} steps to ${filename}`, 'success', 4000);
                    }, 1000);
                } else {
                    console.error('Download not supported');
                    throw new Error('Download not supported in this browser');
                }
                
            } catch (error) {
                console.error('Export error:', error);
                alert('Error exporting data. Please check the console for details.');
            }
        }

        function downloadCSVTemplate() {
            try {
                const templateData = bosFactory.getCSVTemplate();
                
                const blob = new Blob([templateData], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                if (link.download !== undefined) {
                    const filename = 'bos-factory-template.csv';
                    
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    
                    const templateBtn = document.querySelector('button[onclick="downloadCSVTemplate()"]');
                    if (templateBtn) {
                        templateBtn.classList.add('downloading');
                        templateBtn.textContent = 'üìÑ Downloading...';
                    }
                    
                    link.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        
                        if (templateBtn) {
                            templateBtn.classList.remove('downloading');
                            templateBtn.textContent = 'üìÑ Download CSV Template';
                        }
                        
                        showToast(`‚úÖ CSV template downloaded as ${filename}`, 'success');
                    }, 800);
                } else {
                    throw new Error('Download not supported in this browser');
                }
                
            } catch (error) {
                console.error('Template download error:', error);
                alert('Error downloading template. Please check the console for details.');
            }
        }

        function loadDemoData() {
            try {
                showLoading('Loading demo data...');
                
                setTimeout(() => {
                    bosFactory.initializeSampleData();
                    updateDemoStats();
                    renderHierarchyTree();
                    renderStepList();
                    updateExportStats();
                    
                    hideLoading();
                    showToast('‚úÖ Demo data loaded successfully! Explore the samples in View Steps.', 'success', 4000);
                }, 800);
            } catch (error) {
                console.error('Load demo data error:', error);
                hideLoading();
                bosFactory.initializeSampleData();
                updateDemoStats();
                renderHierarchyTree();
                renderStepList();
                updateExportStats();
                showToast('Demo data loaded successfully!', 'success');
            }
        }

        function clearAllData() {
            const confirmMessage = '‚ö†Ô∏è Are you sure you want to clear all data?\n\nThis will permanently delete:\n‚Ä¢ All business processes\n‚Ä¢ All steps and their signals\n‚Ä¢ All saved configurations\n\nThis action cannot be undone.';
            
            if (confirm(confirmMessage)) {
                try {
                    showLoading('Clearing all data...');
                    
                    setTimeout(() => {
                        bosFactory.clearData();
                        updateDemoStats();
                        renderHierarchyTree();
                        renderStepList();
                        updateExportStats();
                        hidePreview();
                        
                        hideLoading();
                        showToast('üßπ All data cleared successfully!', 'info');
                    }, 800);
                } catch (error) {
                    console.error('Clear data error:', error);
                    hideLoading();
                    bosFactory.clearData();
                    updateDemoStats();
                    renderHierarchyTree();
                    renderStepList();
                    updateExportStats();
                    showToast('All data cleared successfully!', 'info');
                }
            }
        }

        function hidePreview() {
            const previewDiv = document.getElementById('export-preview');
            if (previewDiv) {
                previewDiv.style.display = 'none';
            }
        }

        // CSV Import Functions
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                processSelectedFile(file);
            }
        }

        function processSelectedFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('Please select a CSV file (.csv extension required)');
                return;
            }

            const maxSize = 5 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('File too large. Please select a CSV file smaller than 5MB.');
                return;
            }

            selectedFile = file;
            
            document.getElementById('selected-file-name').textContent = file.name;
            document.getElementById('selected-file-stats').textContent = 
                `${formatFileSize(file.size)} ‚Ä¢ ${new Date(file.lastModified).toLocaleDateString()}`;
            
            document.getElementById('file-info').style.display = 'block';
            document.getElementById('import-btn').disabled = false;
            
            hideImportResults();
        }

        function clearFileSelection() {
            selectedFile = null;
            parsedData = null;
            
            document.getElementById('csv-file-input').value = '';
            document.getElementById('file-info').style.display = 'none';
            document.getElementById('import-btn').disabled = true;
            
            hideImportResults();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function hideImportResults() {
            document.getElementById('import-results').style.display = 'none';
            document.getElementById('import-preview').style.display = 'none';
        }

        function processImport() {
            if (!selectedFile) {
                alert('Please select a CSV file first');
                return;
            }

            const importBtn = document.getElementById('import-btn');
            const originalText = importBtn.textContent;
            importBtn.textContent = 'üì• Processing...';
            importBtn.disabled = true;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    parseCSVData(csvText);
                } catch (error) {
                    showImportError('Error reading file: ' + error.message);
                } finally {
                    importBtn.textContent = originalText;
                    importBtn.disabled = false;
                }
            };

            reader.onerror = function() {
                showImportError('Error reading file. Please try again.');
                importBtn.textContent = originalText;
                importBtn.disabled = false;
            };

            reader.readAsText(selectedFile);
        }

        function parseCSVData(csvText) {
            try {
                const results = (typeof Papa !== 'undefined') ? Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: false,
                    transformHeader: function(header) {
                        return header.trim();
                    }
                }) : null;

                if (!results) {
                    parsedData = parseCSVManually(csvText);
                } else if (results.errors && results.errors.length > 0) {
                    const errorMessages = results.errors.map(err => `Row ${err.row + 1}: ${err.message}`);
                    showImportError('CSV parsing errors:\n' + errorMessages.join('\n'));
                    return;
                } else {
                    parsedData = results.data;
                }

                validateImportData();
                
            } catch (error) {
                console.error('Parse error:', error);
                showImportError('Error parsing CSV: ' + error.message);
            }
        }

        function parseCSVManually(csvText) {
            const lines = csvText.split('\n');
            if (lines.length < 2) {
                throw new Error('CSV must have at least a header row and one data row');
            }

            const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    const values = line.split(',').map(v => v.trim().replace(/^"|"$/g, ''));
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    data.push(row);
                }
            }
            
            return data;
        }

        function validateImportData() {
            if (!parsedData || parsedData.length === 0) {
                showImportError('No data found in CSV file');
                return;
            }

            const errors = [];
            const requiredFields = [
                'business_process_name',
                'business_step_name'
            ];

            const headers = Object.keys(parsedData[0]);
            const missingColumns = requiredFields.filter(field => !headers.includes(field));
            
            if (missingColumns.length > 0) {
                errors.push(`Missing required columns: ${missingColumns.join(', ')}`);
            }

            parsedData.forEach((row, index) => {
                const rowNum = index + 1;
                
                requiredFields.forEach(field => {
                    if (!row[field] || row[field].trim() === '') {
                        errors.push(`Row ${rowNum}: ${field} is required`);
                    }
                });
            });

            if (errors.length > 0) {
                showImportErrors(errors);
                return;
            }

            showImportPreview();
        }

        function showImportPreview() {
            const previewDiv = document.getElementById('import-preview');
            const previewTable = document.getElementById('preview-table');
            
            const previewData = parsedData.slice(0, 3);
            const headers = Object.keys(parsedData[0]);
            
            let tableHTML = '<thead><tr>';
            headers.forEach(header => {
                tableHTML += `<th>${header}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            previewData.forEach(row => {
                tableHTML += '<tr>';
                headers.forEach(header => {
                    const value = row[header] || '';
                    const truncated = value.length > 30 ? value.substring(0, 30) + '...' : value;
                    tableHTML += `<td title="${value}">${truncated}</td>`;
                });
                tableHTML += '</tr>';
            });
            tableHTML += '</tbody>';
            
            previewTable.innerHTML = tableHTML;
            previewDiv.style.display = 'block';
            
            previewDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function confirmImport() {
            if (!parsedData) {
                alert('No data to import');
                return;
            }

            try {
                let imported = 0;
                let updated = 0;
                let errors = [];

                console.log('Starting import of', parsedData.length, 'rows');

                parsedData.forEach((row, index) => {
                    try {
                        const stepData = convertCSVRowToStepData(row);
                        console.log(`Processing row ${index + 1}:`, stepData.businessStepName);
                        
                        const importStepData = { ...stepData };
                        delete importStepData.stepId;
                        
                        const result = bosFactory.addStep(stepData.businessProcessName, importStepData);
                        console.log(`Import result for row ${index + 1}:`, result);
                        
                        imported++;
                    } catch (error) {
                        console.error(`Error processing row ${index + 1}:`, error);
                        errors.push(`Row ${index + 1}: ${error.message}`);
                    }
                });

                console.log('Import completed. Imported:', imported, 'Errors:', errors.length);
                console.log('Current data after import:', bosFactory.data);

                setTimeout(() => {
                    updateDemoStats();
                    renderHierarchyTree();
                    renderStepList();
                    console.log('Displays updated');
                }, 100);

                if (errors.length > 0) {
                    showImportResults(imported, updated, errors);
                } else {
                    showImportSuccess(imported, updated);
                }
                
            } catch (error) {
                console.error('Import error:', error);
                showImportError('Error during import: ' + error.message);
            }
        }

        function convertCSVRowToStepData(row) {
            return {
                stepId: row.step_id || undefined,
                businessProcessName: row.business_process_name,
                businessProcessDescription: row.business_process_description || '',
                businessStepName: row.business_step_name,
                businessStepDescription: row.business_step_description || '',
                
                customerRole: {
                    type: 'Customer',
                    value: row.customer_role_value || '',
                    goalIntent: row.customer_role_goal || '',
                    mappedKPIs: row.customer_role_mapped_kpis || '',
                    mappedSignals: row.customer_role_mapped_signals || ''
                },
                
                internalUserRole: {
                    type: 'Internal User',
                    value: row.internal_user_role_value || '',
                    goalIntent: row.internal_user_role_goal || '',
                    mappedKPIs: row.internal_user_role_mapped_kpis || '',
                    mappedSignals: row.internal_user_role_mapped_signals || ''
                },
                
                businessProcessRole: {
                    type: 'Business Process',
                    value: row.business_process_role_value || '',
                    goalIntent: row.business_process_role_goal || '',
                    mappedKPIs: row.business_process_role_mapped_kpis || '',
                    mappedSignals: row.business_process_role_mapped_signals || ''
                },
                
                businessKPI: {
                    name: row.business_kpi_name || '',
                    targetThreshold: row.business_kpi_target || '',
                    formulaDescription: row.business_kpi_formula || ''
                },
                
                businessSignal: {
                    name: row.business_signal_name || '',
                    targetThreshold: row.business_signal_target || '',
                    formulaDescription: row.business_signal_description || ''
                },
                
                technicalFunctionDescription: row.technical_function_description || '',
                technicalFlow: row.technical_flow || '',
                
                processSignal: {
                    name: row.process_signal_name || '',
                    component: row.process_signal_component || '',
                    conditionTrigger: row.process_signal_condition || '',
                    purposeInterpretation: row.process_signal_purpose || ''
                },
                
                systemSignal: {
                    name: row.system_signal_name || '',
                    component: row.system_signal_component || '',
                    conditionTrigger: row.system_signal_condition || '',
                    purposeInterpretation: row.system_signal_purpose || ''
                }
            };
        }

        function cancelImport() {
            document.getElementById('import-preview').style.display = 'none';
        }

        function showImportSuccess(imported, updated) {
            const resultsDiv = document.getElementById('import-results');
            const summaryDiv = document.getElementById('import-summary');
            
            summaryDiv.className = 'import-summary success';
            summaryDiv.innerHTML = `
                <h5>‚úÖ Import Successful!</h5>
                <p><strong>${imported}</strong> new steps imported</p>
                <p><strong>${updated}</strong> existing steps updated</p>
                <p><strong>${imported + updated}</strong> total steps processed</p>
                <p><small>Switch to "View Steps" tab to see your imported data</small></p>
            `;
            
            resultsDiv.style.display = 'block';
            document.getElementById('import-errors').style.display = 'none';
            document.getElementById('import-preview').style.display = 'none';
            
            clearFileSelection();
            
            setTimeout(() => {
                showTab('list');
                resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 2000);
        }

        function showImportResults(imported, updated, errors) {
            const resultsDiv = document.getElementById('import-results');
            const summaryDiv = document.getElementById('import-summary');
            const errorsDiv = document.getElementById('import-errors');
            
            summaryDiv.className = 'import-summary warning';
            summaryDiv.innerHTML = `
                <h5>‚ö†Ô∏è Import Completed with Warnings</h5>
                <p><strong>${imported}</strong> new steps imported</p>
                <p><strong>${updated}</strong> existing steps updated</p>
                <p><strong>${errors.length}</strong> errors encountered</p>
            `;
            
            if (errors.length > 0) {
                errorsDiv.innerHTML = `
                    <h5>Errors:</h5>
                    <ul class="error-list">
                        ${errors.map(error => `<li>${error}</li>`).join('')}
                    </ul>
                `;
                errorsDiv.style.display = 'block';
            }
            
            resultsDiv.style.display = 'block';
            document.getElementById('import-preview').style.display = 'none';
            
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function showImportError(message) {
            const resultsDiv = document.getElementById('import-results');
            const summaryDiv = document.getElementById('import-summary');
            
            summaryDiv.className = 'import-summary error';
            summaryDiv.innerHTML = `
                <h5>‚ùå Import Failed</h5>
                <p>${message}</p>
            `;
            
            resultsDiv.style.display = 'block';
            document.getElementById('import-errors').style.display = 'none';
            document.getElementById('import-preview').style.display = 'none';
            
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function showImportErrors(errors) {
            const resultsDiv = document.getElementById('import-results');
            const summaryDiv = document.getElementById('import-summary');
            const errorsDiv = document.getElementById('import-errors');
            
            summaryDiv.className = 'import-summary error';
            summaryDiv.innerHTML = `
                <h5>‚ùå Validation Failed</h5>
                <p>Please fix the following errors and try again:</p>
            `;
            
            errorsDiv.innerHTML = `
                <h5>Validation Errors:</h5>
                <ul class="error-list">
                    ${errors.map(error => `<li>${error}</li>`).join('')}
                </ul>
            `;
            errorsDiv.style.display = 'block';
            
            resultsDiv.style.display = 'block';
            document.getElementById('import-preview').style.display = 'none';
            
            resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function downloadSampleCSV() {
            try {
                const csvData = bosFactory.exportToCSV();
                
                if (!csvData) {
                    bosFactory.initializeSampleData();
                    const sampleData = bosFactory.exportToCSV();
                    
                    if (sampleData) {
                        downloadFile(sampleData, 'bos-factory-sample.csv', 'text/csv');
                        showToast('‚úÖ Sample CSV downloaded with demo data!', 'success');
                    } else {
                        alert('Error creating sample data');
                    }
                } else {
                    downloadFile(csvData, 'bos-factory-sample.csv', 'text/csv');
                    showToast('‚úÖ Sample CSV downloaded with your current data!', 'success');
                }
                
            } catch (error) {
                console.error('Sample download error:', error);
                alert('Error creating sample CSV. Please check the console for details.');
            }
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 100);
            } else {
                throw new Error('Download not supported in this browser');
            }
        }

        function setupDragAndDrop() {
            const uploadArea = document.getElementById('file-upload-area');
            
            if (!uploadArea) return;
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            uploadArea.addEventListener('drop', handleDrop, false);
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight(e) {
                uploadArea.classList.add('drag-over');
            }
            
            function unhighlight(e) {
                uploadArea.classList.remove('drag-over');
            }
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    processSelectedFile(files[0]);
                }
            }
        }

        // Tree Visualization Functions
        function expandAll() {
            alert('Tree expand functionality will be implemented in next phase');
        }

        function collapseAll() {
            alert('Tree collapse functionality will be implemented in next phase');
        }

        function filterByProcess() {
            alert('Process filtering will be implemented in next phase');
        }

        // Application Initialization
        function initializeApp() {
            console.log('BOS Factory Demo Initializing...');
            
            try {
                bosFactory = new BOSFactory();
                
                const stats = bosFactory.getStats();
                if (stats.processes === 0) {
                    console.log('No data found, loading sample data...');
                    bosFactory.initializeSampleData();
                }
                
                updateDemoStats();
                renderHierarchyTree();
                renderStepList();
                
                setTimeout(() => {
                    try {
                        const stats = bosFactory.getStats();
                        if (stats.processes > 0) {
                            showToast('‚ú® Welcome back! Your data has been loaded.', 'success');
                        } else {
                            showToast('üöÄ Welcome to Business Observability Factory!', 'info');
                        }
                    } catch (error) {
                        console.warn('Welcome message failed:', error);
                    }
                }, 1000);
                
                console.log('BOS Factory Demo Initialized with', stats);
                
            } catch (error) {
                console.error('App initialization failed:', error);
                alert('Application failed to initialize. Please refresh the page.');
            }
        }

        // Initialize the application when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            
            try {
                initializeApp();
            } catch (error) {
                console.error('App initialization error:', error);
                alert('Application failed to initialize properly. Some features may not work. Please refresh the page.');
            }
            
            try {
                setupDragAndDrop();
            } catch (error) {
                console.warn('Drag and drop setup failed:', error);
            }
        });
    </script>
</body>
</html>